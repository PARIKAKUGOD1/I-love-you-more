<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>PROTOCOL: ETERNITY // SYSTEM OMEGA</title>
    <meta name="description" content="Secure Neural Uplink // AMIT + CHARVI">
    <meta name="theme-color" content="#000000">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-status-bar-style" content="black-translucent">

    <!-- ================================================================= -->
    <!--                       EXTERNAL DEPENDENCIES                       -->
    <!-- ================================================================= -->
    
    <!-- Tailwind CSS: Utility-First Styling Framework -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- GSAP: GreenSock Animation Platform (Core + ScrollTrigger) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/ScrollTrigger.min.js"></script>
    
    <!-- Three.js: WebGL Rendering Engine -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>

    <!-- Fontshare API: Typography Assets -->
    <link href="https://api.fontshare.com/v2/css?f[]=clash-display@400,500,600,700&f[]=satoshi@300,400,500,700,900&f[]=share-tech-mono@400&display=swap" rel="stylesheet">

    <!-- ================================================================= -->
    <!--                       SYSTEM CONFIGURATION                        -->
    <!-- ================================================================= -->
    <script>
        /**
         * SYSTEM_CONFIG
         * Global configuration registry for the Protocol Eternity environment.
         * Controls visuals, audio synthesis parameters, game difficulty scaling, 
         * and network endpoints for the discord webhook integration.
         */
        const SYSTEM_CONFIG = {
            meta: {
                targetName: "CHARVI",
                adminName: "AMIT",
                protocolDate: "2025.11.20",
                version: "4.2.0-OMEGA",
                build: "RELEASE_CANDIDATE_FINAL"
            },
            colors: {
                brand: '#ff003c',   // Primary Alert Red - Used for critical elements
                cyan: '#00f3ff',    // System Interface Blue - Used for data visualization
                void: '#020203',    // Deep Space Black - Background
                gold: '#ffd700',    // Achievement Gold - Rewards
                glass: 'rgba(10, 12, 16, 0.85)', // Glassmorphism Base
                error: '#ff0000',   // Hard Error
                success: '#00ff00'  // Success State
            },
            audio: {
                masterVolume: 0.15,
                waveforms: {
                    primary: 'sawtooth',
                    secondary: 'square',
                    ambient: 'sine'
                },
                frequencies: {
                    shoot: 600,
                    hit: 100,
                    collect: 1200,
                    heart: 800,
                    rumble: 50,
                    slam: 40,
                    spark: 2000
                }
            },
            games: {
                labyrinth: {
                    gridSize: 15,
                    shardCount: 5,
                    visionRadius: 5.5, // Raycasting limit
                    wallOpacity: 0.8
                },
                guardian: {
                    spawnRateMs: 1000,
                    winScore: 500,
                    playerHealth: 100,
                    shieldRadius: 50
                },
                lexicon: {
                    spawnRateMs: 2200,
                    winScore: 8,
                    words: [
                        "LOVE", "HOPE", "AMIT", "CHARVI", "KISS", "SOUL", 
                        "FOREVER", "TRUST", "DREAM", "HEART", "PASSION", 
                        "FUTURE", "ETERNITY", "DEVOTION", "ALWAYS"
                    ]
                }
            },
            network: {
                discordWebhook: "https://discord.com/api/webhooks/1442055812439740416/zGol_ouB_GkxGfIJZ28fJ8CJUPSxsScDdkFYzc0rO4D9XuieCk1Gbx2WRM8pnfkaydx0"
            },
            boot: {
                sequenceDuration: 2.5, // Seconds
                logSpeed: 50 // Milliseconds per line
            }
        };

        // Tailwind Configuration Injection
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        display: ['Clash Display', 'sans-serif'],
                        body: ['Satoshi', 'sans-serif'],
                        mono: ['Share Tech Mono', 'monospace'],
                    },
                    colors: SYSTEM_CONFIG.colors,
                    animation: {
                        'pulse-fast': 'pulse 1s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                        'float': 'float 6s ease-in-out infinite',
                        'shake': 'shake 0.5s cubic-bezier(.36,.07,.19,.97) both',
                        'glitch': 'glitch 0.2s linear infinite',
                        'scan': 'scan 4s linear infinite',
                    },
                    keyframes: {
                        shake: {
                            '10%, 90%': { transform: 'translate3d(-1px, 0, 0)' },
                            '20%, 80%': { transform: 'translate3d(2px, 0, 0)' },
                            '30%, 50%, 70%': { transform: 'translate3d(-4px, 0, 0)' },
                            '40%, 60%': { transform: 'translate3d(4px, 0, 0)' }
                        },
                        float: {
                            '0%, 100%': { transform: 'translateY(0)' },
                            '50%': { transform: 'translateY(-10px)' }
                        },
                        glitch: {
                            '0%': { transform: 'translate(2px,0) skew(0deg)', opacity: '1' },
                            '20%': { transform: 'translate(-2px,0) skew(10deg)', opacity: '0.8' },
                            '40%': { transform: 'translate(0,0) skew(-5deg)', opacity: '1' },
                            '60%': { transform: 'translate(1px,2px) skew(0deg)', opacity: '0.9' },
                            '80%': { transform: 'translate(-1px,-2px) skew(0deg)', opacity: '1' },
                            '100%': { transform: 'translate(0,0) skew(0deg)', opacity: '1' }
                        },
                        scan: {
                            '0%': { transform: 'translateY(-100%)' },
                            '100%': { transform: 'translateY(100%)' }
                        }
                    }
                }
            }
        };
    </script>

    <style>
        /* ================================================================= */
        /* CORE STYLESHEET                                                   */
        /* ================================================================= */

        :root {
            --color-void: #020203;
            --color-brand: #ff003c;
            --color-cyan: #00f3ff;
            --cursor-size: 20px;
        }

        body {
            background-color: var(--color-void);
            color: #ffffff;
            overflow-x: hidden;
            margin: 0;
            -webkit-tap-highlight-color: transparent;
            user-select: none;
            touch-action: none; /* Critical for custom game controls */
            cursor: none; /* Hide default cursor on PC */
        }

        /* ================================================================= */
        /* PC-ONLY CURSOR TRACKER                                            */
        /* ================================================================= */
        
        #cursor-tracker {
            position: fixed;
            top: 0;
            left: 0;
            width: var(--cursor-size);
            height: var(--cursor-size);
            border: 1px solid var(--color-cyan);
            border-radius: 50%;
            pointer-events: none;
            z-index: 99999;
            mix-blend-mode: difference;
            transform: translate(-50%, -50%);
            transition: width 0.2s, height 0.2s, background-color 0.2s;
            display: none; /* Hidden by default */
        }

        #cursor-tracker::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 4px;
            height: 4px;
            background: var(--color-brand);
            border-radius: 50%;
            transform: translate(-50%, -50%);
        }

        /* Only show on fine pointer devices (Mouse/Trackpad) */
        @media (pointer: fine) {
            #cursor-tracker {
                display: block;
            }
            body {
                cursor: none; /* Ensure system cursor is gone */
            }
        }

        /* ================================================================= */
        /* VISUAL LAYERS                                                     */
        /* ================================================================= */

        #canvas-container {
            position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; z-index: 0; pointer-events: none;
        }
        .vignette {
            position: fixed; inset: 0; background: radial-gradient(circle at center, transparent 0%, var(--color-void) 130%); pointer-events: none; z-index: 1;
        }
        
        /* ================================================================= */
        /* UI COMPONENTS                                                     */
        /* ================================================================= */

        .boot-elem {
            opacity: 0; transform: translateY(20px); filter: blur(5px); will-change: transform, opacity, filter;
        }

        .glass-panel {
            background: rgba(10, 12, 16, 0.85);
            backdrop-filter: blur(16px); -webkit-backdrop-filter: blur(16px);
            border: 1px solid rgba(255, 255, 255, 0.08);
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
            transform-style: preserve-3d;
        }

        .tilt-card { transition: transform 0.1s ease-out; }

        /* ================================================================= */
        /* GAME ENGINE UI                                                    */
        /* ================================================================= */

        #game-overlay {
            position: fixed; inset: 0; background: #050505; z-index: 5000;
            display: none; flex-direction: column; justify-content: flex-start; align-items: center; padding-top: 10px;
        }

        canvas.game-canvas {
            border: 2px solid #333;
            box-shadow: 0 0 30px rgba(0, 243, 255, 0.15);
            background-color: #000;
            max-width: 100%;
            touch-action: none;
            image-rendering: pixelated;
        }

        /* ================================================================= */
        /* HELP SYSTEM MODAL                                                 */
        /* ================================================================= */

        #amit-help-modal {
            position: absolute; inset: 0; z-index: 6000;
            background: rgba(0,0,0,0.9); backdrop-filter: blur(12px);
            display: none; flex-direction: column; justify-content: center; align-items: center;
            padding: 20px; text-align: center;
        }

        .floating-heart {
            position: absolute; color: var(--color-brand); font-size: 24px; pointer-events: none;
            animation: floatUp 1.5s ease-out forwards; z-index: 7000;
        }
        @keyframes floatUp { 
            0% { transform: translateY(0) scale(1); opacity: 1; } 
            100% { transform: translateY(-150px) scale(1.5); opacity: 0; } 
        }

        .chat-bubble {
            position: relative; background: #111; border: 1px solid var(--color-brand);
            padding: 15px; border-radius: 15px; border-bottom-left-radius: 0;
            box-shadow: 0 0 20px rgba(255,0,60,0.2); max-width: 300px; margin-bottom: 20px;
        }
        .chat-bubble::after {
            content: ''; position: absolute; bottom: -10px; left: 0;
            border-width: 10px 10px 0; border-style: solid;
            border-color: var(--color-brand) transparent transparent transparent;
        }

        /* ================================================================= */
        /* CONTROLS & INPUTS                                                 */
        /* ================================================================= */

        .d-pad-btn {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(0, 243, 255, 0.2);
            color: var(--color-cyan);
            width: 65px; height: 65px;
            display: flex; justify-content: center; align-items: center;
            border-radius: 16px; font-size: 24px;
            touch-action: manipulation; user-select: none;
            transition: background 0.1s;
        }
        .d-pad-btn:active { background: rgba(0, 243, 255, 0.3); transform: scale(0.95); }

        #hidden-keyboard-input { position: absolute; opacity: 0; top: -1000px; left: -1000px; }

        /* ================================================================= */
        /* FINALE VISUALS                                                    */
        /* ================================================================= */

        .glitch-text { animation: glitch 0.2s linear infinite; }
        @keyframes glitch {
            0% { transform: translate(2px,0) skew(0deg); opacity: 1; }
            20% { transform: translate(-2px,0) skew(10deg); opacity: 0.8; }
            40% { transform: translate(0,0) skew(-5deg); opacity: 1; }
            60% { transform: translate(1px,2px) skew(0deg); opacity: 0.9; }
            80% { transform: translate(-1px,-2px) skew(0deg); opacity: 1; }
            100% { transform: translate(0,0) skew(0deg); opacity: 1; }
        }

        #crack-overlay {
            position: absolute; inset: 0; pointer-events: none; z-index: 10001;
            background-image: url("data:image/svg+xml,%3Csvg width='100%25' height='100%25' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M500,500 L400,300 L600,200 L500,500 L300,600 L200,400 L500,500 L700,700 L800,500 L500,500 L450,800 L500,500' stroke='white' stroke-width='2' fill='none' stroke-opacity='0.8'/%3E%3C/svg%3E");
            background-size: cover; display: none; opacity: 0.6; mix-blend-mode: overlay;
        }
        
        #bulb-canvas {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            pointer-events: none; z-index: 9999;
        }
    </style>
</head>
<body class="antialiased">

    <!-- CUSTOM CURSOR (PC ONLY) -->
    <div id="cursor-tracker"></div>

    <!-- ================================================================= -->
    <!-- MODULE 1: SYSTEM BOOTLOADER                                       -->
    <!-- ================================================================= -->
    <div id="init-screen" class="fixed inset-0 bg-black z-[10000] flex flex-col justify-center items-center cursor-pointer select-none">
        <div class="relative w-40 h-40 mb-10 group">
            <div class="absolute inset-0 bg-brand/20 rounded-full animate-ping opacity-75"></div>
            <div class="relative z-10 w-full h-full rounded-full border border-brand flex items-center justify-center backdrop-blur-md shadow-[0_0_50px_#ff003c] transition-transform duration-500 group-hover:scale-105">
                <div class="text-center">
                    <div class="text-[10px] text-brand font-mono tracking-widest mb-1">SYSTEM</div>
                    <div class="text-3xl text-white font-bold tracking-tighter font-display">OFFLINE</div>
                </div>
            </div>
        </div>
        <p class="text-gray-500 text-xs font-mono tracking-[0.5em] group-hover:text-brand transition-colors animate-pulse uppercase">Tap to Initialize Protocol</p>
    </div>

    <!-- ================================================================= -->
    <!-- MODULE 2: BIOS LOADER (SCROLLING LOG)                             -->
    <!-- ================================================================= -->
    <div id="loader" class="fixed inset-0 bg-[#020203] z-[9999] hidden flex-col justify-center items-center p-10">
        <div class="font-mono text-cyan text-xs tracking-[0.3em] mb-4 uppercase text-shadow-cyan">Initializing Core Systems...</div>
        
        <!-- Visual Loading Bar -->
        <div class="w-64 h-[2px] bg-gray-800 relative overflow-hidden rounded-full mb-6">
            <div id="loader-bar" class="absolute top-0 left-0 h-full bg-cyan w-0 shadow-[0_0_15px_#00f3ff]"></div>
        </div>

        <!-- Scrolling System Log -->
        <div id="boot-log" class="font-mono text-[10px] text-gray-600 h-32 overflow-hidden text-center leading-relaxed opacity-80"></div>
    </div>

    <!-- ================================================================= -->
    <!-- MODULE 3: VISUALIZATION LAYERS                                    -->
    <!-- ================================================================= -->
    <div id="canvas-container"></div>
    <div class="vignette"></div>

    <!-- ================================================================= -->
    <!-- MODULE 4: MAIN DASHBOARD INTERFACE                                -->
    <!-- ================================================================= -->
    <!-- Note: Hidden initially. Revealed via GSAP sequence in BootController -->
    <main class="relative z-10 overflow-y-auto h-screen hidden" id="main-ui">
        
        <!-- HUD HEADER -->
        <header class="fixed top-0 w-full p-6 flex justify-between items-center pointer-events-none z-50 mix-blend-screen boot-elem">
            <div class="flex flex-col">
                <span class="text-[10px] font-mono text-gray-500 tracking-widest">TARGET_ID</span>
                <span class="text-xs font-bold text-white tracking-widest">CHARVI</span>
            </div>
            <div class="flex items-center gap-4">
                 <div class="text-right">
                    <div class="text-[10px] font-mono text-gray-500">SYSTEM SYNC</div>
                    <div class="text-xs font-bold text-brand" id="sync-percent">0%</div>
                </div>
                <div class="w-1.5 h-1.5 bg-brand rounded-full animate-pulse shadow-[0_0_10px_#ff003c]"></div>
            </div>
        </header>

        <section class="min-h-screen flex flex-col items-center justify-center px-4 pt-20 pb-10">
            
            <!-- HERO CARD -->
            <div class="glass-panel p-8 md:p-12 rounded-[2rem] max-w-lg w-full text-center relative border-t border-cyan/20 tilt-card mb-12 boot-elem">
                <div class="inline-block px-3 py-1 rounded-full border border-cyan/30 bg-cyan/5 text-cyan text-[10px] font-mono tracking-[0.3em] mb-8">TEMPORAL LOCK</div>
                <h1 class="text-6xl md:text-8xl font-display font-bold text-white mb-2 tracking-tighter leading-none">
                    09:26 <span class="text-xl md:text-2xl text-gray-600 font-light absolute top-2 ml-2">PM</span>
                </h1>
                <div class="text-2xl md:text-3xl font-body text-brand font-light tracking-wide mb-6">Nov 20, 2025</div>
                <p class="text-gray-400 text-xs md:text-sm font-mono leading-relaxed tracking-wide">// LOG ENTRY:<br>The exact coordinate in time where logic failed and my heart took over.</p>
            </div>

            <!-- STATISTICS GRID -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 w-full max-w-5xl px-2 mb-12 boot-elem">
                <!-- Card 1: Heart Rate -->
                <div class="glass-panel p-8 rounded-2xl relative border-l-4 border-brand group hover:bg-white/5 transition-colors">
                    <div class="absolute top-6 right-6 text-[10px] font-mono text-brand border border-brand/30 px-2 py-1 rounded">PHYSIOLOGY</div>
                    <h3 class="text-2xl font-display font-bold text-white mb-2">Cardiac Anomaly</h3>
                    <p class="text-gray-400 text-xs leading-relaxed mb-6 font-mono border-l-2 border-white/10 pl-4">Fatal levels of love detected.</p>
                    <div class="flex items-baseline gap-2">
                        <span class="text-6xl font-display font-bold text-brand tabular-nums" id="bpm-counter">0</span>
                        <span class="text-xs font-mono text-gray-500">BPM</span>
                    </div>
                </div>
                <!-- Card 2: Priority Index -->
                <div class="glass-panel p-8 rounded-2xl relative border-l-4 border-cyan group hover:bg-white/5 transition-colors">
                    <div class="absolute top-6 right-6 text-[10px] font-mono text-cyan border border-cyan/30 px-2 py-1 rounded">LATENCY</div>
                    <h3 class="text-2xl font-display font-bold text-white mb-2">Priority Index</h3>
                    <p class="text-gray-400 text-xs leading-relaxed mb-6 font-mono border-l-2 border-white/10 pl-4">Response time: 0.00s. Obsessed.</p>
                    <div class="w-full bg-gray-800 h-2 rounded-full overflow-hidden mb-2">
                        <div class="h-full bg-cyan w-[99.9%] shadow-[0_0_20px_#00f3ff] animate-pulse"></div>
                    </div>
                    <div class="flex justify-between text-[10px] font-mono text-cyan"><span>STATUS: CRITICAL</span><span>MAX</span></div>
                </div>
            </div>
            
            <div class="text-center mb-8 w-full max-w-4xl boot-elem">
                <h2 class="text-3xl md:text-5xl font-display font-bold text-white mb-4">Trials of Devotion</h2>
                <p class="text-gray-500 font-mono text-[10px] tracking-widest uppercase">Complete all modules to unlock the final truth</p>
            </div>

            <!-- GAMES LAUNCHPAD -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 w-full max-w-5xl px-2 mb-20">
                <!-- Game 1: Labyrinth -->
                <div class="glass-panel p-6 rounded-2xl border border-white/10 active:scale-95 transition-transform duration-150 cursor-pointer group boot-elem" onclick="GameController.start(1)">
                    <div class="h-32 bg-black/40 rounded-xl mb-4 flex items-center justify-center overflow-hidden relative border border-white/5">
                        <div class="text-4xl md:text-5xl group-hover:scale-110 transition-transform duration-300 drop-shadow-[0_0_15px_rgba(0,243,255,0.5)]">üí†</div>
                    </div>
                    <h3 class="text-lg font-bold text-white mb-1 font-display">Labyrinth</h3>
                    <div class="text-[10px] font-mono text-cyan border border-cyan/30 inline-block px-2 py-1 rounded status-g1">PENDING</div>
                </div>

                <!-- Game 2: Guardian -->
                <div class="glass-panel p-6 rounded-2xl border border-white/10 active:scale-95 transition-transform duration-150 cursor-pointer group boot-elem" onclick="GameController.start(2)">
                    <div class="h-32 bg-black/40 rounded-xl mb-4 flex items-center justify-center overflow-hidden relative border border-white/5">
                        <div class="text-4xl md:text-5xl group-hover:scale-110 transition-transform duration-300 drop-shadow-[0_0_15px_rgba(255,0,60,0.5)]">üõ°Ô∏è</div>
                    </div>
                    <h3 class="text-lg font-bold text-white mb-1 font-display">Guardian</h3>
                    <div class="text-[10px] font-mono text-brand border border-brand/30 inline-block px-2 py-1 rounded status-g2">PENDING</div>
                </div>

                <!-- Game 3: Lexicon -->
                <div class="glass-panel p-6 rounded-2xl border border-white/10 active:scale-95 transition-transform duration-150 cursor-pointer group boot-elem" onclick="GameController.start(3)">
                    <div class="h-32 bg-black/40 rounded-xl mb-4 flex items-center justify-center overflow-hidden relative border border-white/5">
                        <div class="text-4xl md:text-5xl group-hover:scale-110 transition-transform duration-300 drop-shadow-[0_0_15px_rgba(255,215,0,0.5)]">‚å®Ô∏è</div>
                    </div>
                    <h3 class="text-lg font-bold text-white mb-1 font-display">Lexicon</h3>
                    <div class="text-[10px] font-mono text-gold border border-gold/30 inline-block px-2 py-1 rounded status-g3">PENDING</div>
                </div>
            </div>

            <!-- SECURE CHAT TERMINAL -->
            <div class="w-full max-w-md glass-panel rounded-3xl overflow-hidden shadow-2xl border border-white/10 mb-20 relative boot-elem">
                <div class="bg-black/60 p-4 border-b border-white/5 flex justify-between items-center">
                    <span class="text-[10px] font-mono text-gray-400 tracking-wider">SECURE_CHAT // AMIT</span>
                    <button onclick="NetworkSystem.ping()" class="text-[10px] bg-brand/20 hover:bg-brand/40 px-3 py-1 rounded-full text-brand border border-brand/50 transition-all font-bold animate-pulse shadow-[0_0_10px_#ff003c]">üì° PING AMIT</button>
                </div>
                <div class="p-4 space-y-4 h-48 bg-black/20 overflow-y-auto text-[10px] md:text-xs scroll-smooth">
                    <div class="flex gap-4"><div class="bg-cyan/10 text-cyan p-3 rounded-2xl rounded-tl-none border border-cyan/20 max-w-[85%]">Calculated Fact: My love > Your love. Margin of error: 0%.</div></div>
                    <div class="flex gap-4 flex-row-reverse"><div class="bg-brand/10 text-brand p-3 rounded-2xl rounded-tr-none border border-brand/20 max-w-[85%]">Impossible. Check your math again.</div></div>
                    <div class="flex gap-4"><div class="bg-cyan/10 text-cyan p-3 rounded-2xl rounded-tl-none border border-cyan/20 max-w-[85%]">Logic verified. Try to deny it below.</div></div>
                </div>
                <div class="p-4 bg-black/60 border-t border-white/5 relative">
                    <input type="text" id="rigged-input" placeholder="Type 'I love you more'..." class="w-full p-3 rounded-xl text-white text-xs font-mono placeholder-gray-600 bg-black/50 border border-white/10 focus:outline-none focus:border-brand transition-colors" autocomplete="off">
                    <div id="input-error" class="absolute bottom-2 right-5 text-[9px] text-brand font-mono opacity-0 transition-opacity font-bold">‚ö† REWRITTEN BY PROTOCOL</div>
                </div>
            </div>

            <!-- Acceptance Module -->
            <div id="final-card" class="glass-panel p-8 md:p-12 rounded-[3rem] max-w-md w-full text-center relative z-20 border border-white/10 mb-20 boot-elem">
                <div class="w-20 h-20 mx-auto bg-gradient-to-b from-brand to-purple-900 rounded-full flex items-center justify-center mb-6 shadow-[0_0_60px_rgba(255,0,60,0.6)] animate-float relative">
                     <div class="absolute inset-0 bg-brand rounded-full animate-ping opacity-20"></div>
                    <svg class="w-8 h-8 text-white relative z-10" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z"/></svg>
                </div>
                <h2 class="text-3xl font-display font-bold text-white mb-2">Accept Truth</h2>
                <div id="lock-message" class="text-brand font-mono text-[10px] mb-6 border border-brand/30 bg-brand/5 p-2 rounded flex items-center justify-center gap-2 animate-pulse">
                    üîí LOCKED. COMPLETE TRIALS.
                </div>
                <p class="text-gray-400 text-xs mb-8 font-body leading-relaxed">Acknowledge that Amit's love is the universal constant.</p>
                <div class="relative h-14 w-full group">
                    <button id="deny-btn" class="absolute inset-0 w-full h-full bg-gray-900/80 border border-white/10 text-gray-500 rounded-2xl text-xs font-mono uppercase tracking-[0.2em] z-20 transition-all backdrop-blur-sm">DENY</button>
                    <button id="accept-btn" class="absolute inset-0 w-full h-full bg-gradient-to-r from-brand to-purple-600 text-white rounded-2xl font-bold tracking-[0.3em] shadow-[0_0_40px_rgba(255,0,60,0.6)] z-50 opacity-0 pointer-events-none transition-all duration-500 transform scale-90">I ACCEPT</button>
                </div>
            </div>
        </section>
    </main>

    <!-- ================================================================= -->
    <!-- MODULE 5: GAME OVERLAY                                            -->
    <!-- ================================================================= -->
    <div id="game-overlay">
        <div class="w-full max-w-4xl p-4 flex justify-between items-center mb-1 z-10">
            <div>
                <h2 id="game-title" class="text-xl md:text-3xl font-display font-bold text-white tracking-widest text-shadow-cyan">GAME</h2>
                <p id="game-instruction" class="text-gray-400 font-mono text-[10px] md:text-xs tracking-wider">INSTRUCTIONS</p>
            </div>
            <div class="flex gap-2 items-start">
                 <button id="help-btn" onclick="HelpSystem.activate()" class="hidden text-[10px] md:text-xs bg-brand text-white border border-brand px-3 py-1 rounded hover:bg-red-600 transition-colors animate-pulse font-bold shadow-[0_0_15px_#ff003c]">üìû CALL AMIT</button>
                 <div class="text-right flex flex-col items-end gap-1">
                     <div id="game-score" class="text-xl font-mono text-brand font-bold">0000</div>
                     <button onclick="GameController.close()" class="text-[10px] text-red-500 border border-red-500 px-2 py-1 hover:bg-red-500 hover:text-white transition-colors">EXIT</button>
                 </div>
            </div>
        </div>
        
        <div class="relative w-full flex flex-col justify-center items-center flex-1">
            <canvas id="active-canvas" class="game-canvas mb-4"></canvas>
            
            <!-- Mobile D-Pad -->
            <div id="d-pad" class="grid grid-cols-3 gap-3 hidden touch-none select-none pb-8">
                <div></div><button class="d-pad-btn" id="btn-up">‚ñ≤</button><div></div>
                <button class="d-pad-btn" id="btn-left">‚óÄ</button><div class="w-[65px] h-[65px]"></div><button class="d-pad-btn" id="btn-right">‚ñ∂</button>
                <div></div><button class="d-pad-btn" id="btn-down">‚ñº</button><div></div>
            </div>

            <!-- Keyboard Bridge -->
            <div id="typing-ui" class="absolute bottom-0 left-0 w-full text-center hidden pb-8">
                <div class="bg-black/90 backdrop-blur border-y border-cyan/30 py-4 px-4">
                    <p class="text-xs text-gray-500 font-mono mb-2">COMMAND LINE INPUT:</p>
                    <div class="flex items-center justify-center gap-2">
                        <span id="player-typed" class="text-2xl md:text-3xl font-mono text-white font-bold tracking-widest min-h-[40px] block"></span>
                        <span class="animate-pulse text-brand text-3xl">|</span>
                    </div>
                    <input type="text" id="hidden-keyboard-input" autocomplete="off" spellcheck="false">
                    <button id="keyboard-trigger" class="mt-4 text-xs font-mono text-cyan border border-cyan px-4 py-2 rounded md:hidden">‚å® OPEN KEYBOARD</button>
                </div>
            </div>
        </div>

        <!-- Amit Help Modal -->
        <div id="amit-help-modal">
            <div class="chat-bubble">
                <p class="text-white text-xs md:text-sm font-mono leading-relaxed">
                    "Don't worry darling, I'm here to handle it for you! But I need some love from you to be able to complete it. Click the heart button repeatedly to flood me with love. Love is my fuel! ‚ù§Ô∏è"
                </p>
                <div class="text-[10px] text-brand mt-2 font-bold text-right">- Amit</div>
            </div>
            <div class="w-64 h-4 bg-gray-800 rounded-full overflow-hidden mb-6 border border-white/10">
                <div id="love-bar" class="h-full bg-brand w-0 transition-all duration-200 shadow-[0_0_10px_#ff003c]"></div>
            </div>
            <button id="love-btn" class="w-24 h-24 rounded-full bg-brand text-white text-4xl shadow-[0_0_30px_#ff003c] active:scale-90 transition-transform flex items-center justify-center animate-pulse-fast" onclick="HelpSystem.giveLove()">
                ‚ù§Ô∏è
            </button>
            <div id="love-msg" class="h-6 mt-4 text-cyan font-mono text-xs font-bold"></div>
        </div>
    </div>

    <!-- ================================================================= -->
    <!-- MODULE 6: CINEMATIC FINALE                                        -->
    <!-- ================================================================= -->
    <div id="finale-overlay" class="fixed inset-0 bg-black z-[9998] hidden flex-col justify-center items-center opacity-0 pointer-events-none overflow-hidden">
        <canvas id="finale-canvas" class="absolute inset-0 z-0"></canvas>
        <canvas id="bulb-canvas" class="absolute inset-0 z-10 pointer-events-none"></canvas>
        <div id="crack-overlay"></div>
        
        <div class="relative z-20 flex flex-col items-center justify-center h-full text-center px-4 w-full">
            <h1 class="text-6xl md:text-9xl font-display font-bold text-white mb-6 scale-0 opacity-0 blur-xl text-shadow-red" id="finale-text">FOREVER.</h1>
            <div class="text-white/80 font-mono tracking-[0.5em] text-[10px] md:text-sm opacity-0 translate-y-12 transition-all duration-[2000ms] delay-1000" id="finale-sub">UNIVERSE REBOOTED // SEED: CHARVI</div>
            
            <!-- Custom Message Input -->
            <div id="custom-msg-ui" class="mt-10 opacity-0 transform translate-y-10 transition-all duration-1000 glass-panel p-6 rounded-2xl w-full max-w-sm hidden">
                <p class="text-xs text-cyan font-mono mb-4 animate-pulse">WANNA SEND A CUSTOM MESSAGE TO AMIT?</p>
                <textarea id="final-msg-input" class="w-full bg-black/50 border border-white/20 rounded-lg p-3 text-xs text-white mb-4 h-24 font-mono focus:border-cyan outline-none" placeholder="Type something sweet..."></textarea>
                <button onclick="NetworkSystem.sendCustom()" class="w-full bg-cyan text-black font-bold py-3 rounded-lg text-xs hover:bg-white transition-colors">SEND TRANSMISSION</button>
            </div>
        </div>
        
        <div id="white-flash" class="absolute inset-0 bg-white pointer-events-none opacity-0 z-50"></div>
    </div>

    <!-- ================================================================= -->
    <!--                       SYSTEM CORE LOGIC                           -->
    <!-- ================================================================= -->
    <script>
        /* ----------------------------------------------------------------- */
        /* CLASS: NetworkSystem                                              */
        /* Handles all secure communication with Discord webhooks.           */
        /* ----------------------------------------------------------------- */
        class NetworkSystem {
            static webhook = SYSTEM_CONFIG.network.discordWebhook;

            static send(message) {
                const payload = {
                    content: message,
                    username: `PROTOCOL ${SYSTEM_CONFIG.meta.version}`
                };
                fetch(this.webhook, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify(payload)
                }).catch(err => console.error("Uplink Error:", err));
            }

            static ping() {
                this.send("üì° **INCOMING PING:** Charvi is trying to reach you from the console! ‚ù§Ô∏è");
                alert("Signal locked. Transmission sent to Amit. ‚ù§Ô∏è");
            }

            static sendCustom() {
                const input = document.getElementById('final-msg-input');
                const text = input.value.trim();
                if (!text) return;
                
                this.send(`üíå **CUSTOM TRANSMISSION FROM CHARVI:**\n> "${text}"`);
                
                // UI Feedback
                const ui = document.getElementById('custom-msg-ui');
                ui.innerHTML = `
                    <div class="flex flex-col items-center justify-center h-32">
                        <div class="text-4xl mb-2">‚ù§Ô∏è</div>
                        <div class="text-green-500 font-mono text-sm font-bold tracking-widest">TRANSMISSION RECEIVED</div>
                    </div>
                `;
            }
        }

        /* ----------------------------------------------------------------- */
        /* CLASS: AudioController                                            */
        /* Procedural Audio Synthesis Engine using Web Audio API.            */
        /* Generates all sound effects in real-time (no external files).     */
        /* ----------------------------------------------------------------- */
        class AudioController {
            constructor() {
                this.ctx = null;
                this.gainNode = null;
                this.initialized = false;
            }

            init() {
                if (this.initialized) return;
                try {
                    const AudioContext = window.AudioContext || window.webkitAudioContext;
                    this.ctx = new AudioContext();
                    this.gainNode = this.ctx.createGain();
                    this.gainNode.gain.value = SYSTEM_CONFIG.audio.masterVolume;
                    this.gainNode.connect(this.ctx.destination);
                    this.initialized = true;
                } catch (e) {
                    console.warn("Audio hardware unreachable:", e);
                }
            }

            playTone(freq, type, duration, volMultiplier = 1.0) {
                if (!this.ctx) return;
                
                const osc = this.ctx.createOscillator();
                const gain = this.ctx.createGain();
                
                osc.type = type;
                osc.frequency.setValueAtTime(freq, this.ctx.currentTime);
                
                gain.gain.setValueAtTime(SYSTEM_CONFIG.audio.masterVolume * volMultiplier, this.ctx.currentTime);
                gain.gain.exponentialRampToValueAtTime(0.01, this.ctx.currentTime + duration);
                
                osc.connect(gain);
                gain.connect(this.gainNode);
                
                osc.start();
                osc.stop(this.ctx.currentTime + duration);
            }

            playNoise(duration) {
                if (!this.ctx) return;
                const bufferSize = this.ctx.sampleRate * duration;
                const buffer = this.ctx.createBuffer(1, bufferSize, this.ctx.sampleRate);
                const data = buffer.getChannelData(0);
                
                for (let i = 0; i < bufferSize; i++) {
                    data[i] = Math.random() * 2 - 1;
                }

                const noise = this.ctx.createBufferSource();
                noise.buffer = buffer;
                
                const gain = this.ctx.createGain();
                gain.gain.setValueAtTime(0.2, this.ctx.currentTime);
                gain.gain.exponentialRampToValueAtTime(0.01, this.ctx.currentTime + duration);
                
                noise.connect(gain);
                gain.connect(this.gainNode);
                noise.start();
            }

            // Public SFX Methods
            shoot() { this.playTone(600, 'square', 0.1); }
            hit() { this.playTone(100, 'sawtooth', 0.3, 2.0); }
            collect() { this.playTone(1200, 'sine', 0.2); }
            heartbeat() { this.playTone(SYSTEM_CONFIG.audio.frequencies.heart, 'sine', 0.2, 1.5); }
            error() { this.playTone(150, 'sawtooth', 0.4, 1.5); }
            
            win() {
                if (!this.ctx) return;
                [400, 500, 600, 800].forEach((f, i) => {
                    setTimeout(() => this.playTone(f, 'triangle', 0.4), i * 150);
                });
            }

            slam() {
                this.playTone(40, 'square', 0.5, 2.0);
                this.playTone(100, 'sawtooth', 0.4, 1.5);
            }
        }
        const SFX = new AudioController();

        /* ----------------------------------------------------------------- */
        /* CLASS: VisualEngine                                               */
        /* Manages Three.js scenes, cameras, and renderers.                  */
        /* Handles particle systems (Heart, Stars) and the 3D Lightbulb.     */
        /* ----------------------------------------------------------------- */
        class VisualEngine {
            constructor() {
                this.scene = null;
                this.camera = null;
                this.renderer = null;
                this.heartParticles = null;
                this.starParticles = null;
            }

            init() {
                const container = document.getElementById('canvas-container');
                this.scene = new THREE.Scene();
                this.camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 2000);
                this.camera.position.z = 40;

                this.renderer = new THREE.WebGLRenderer({ alpha: true, antialias: true });
                this.renderer.setSize(window.innerWidth, window.innerHeight);
                container.appendChild(this.renderer.domElement);

                this.createHeart();
                this.createStars();
                this.animate();

                window.addEventListener('resize', () => this.handleResize());
            }

            createHeart() {
                const geometry = new THREE.BufferGeometry();
                const positions = [];
                const colors = [];
                const color1 = new THREE.Color(SYSTEM_CONFIG.colors.brand);
                const color2 = new THREE.Color(SYSTEM_CONFIG.colors.cyan);

                for (let i = 0; i < 4000; i++) {
                    const t = Math.random() * Math.PI * 2;
                    // Heart Formula
                    let x = 16 * Math.pow(Math.sin(t), 3);
                    let y = 13 * Math.cos(t) - 5 * Math.cos(2 * t) - 2 * Math.cos(3 * t) - Math.cos(4 * t);
                    
                    const scale = Math.sqrt(Math.random());
                    x *= scale;
                    y *= scale;
                    let z = (Math.random() - 0.5) * 15 * scale;

                    positions.push(x, y, z);

                    const c = Math.random() > 0.5 ? color1 : color2;
                    colors.push(c.r, c.g, c.b);
                }

                geometry.setAttribute('position', new THREE.Float32BufferAttribute(positions, 3));
                geometry.setAttribute('color', new THREE.Float32BufferAttribute(colors, 3));

                const material = new THREE.PointsMaterial({
                    size: 0.2,
                    vertexColors: true,
                    transparent: true,
                    opacity: 0.6,
                    blending: THREE.AdditiveBlending
                });

                this.heartParticles = new THREE.Points(geometry, material);
                this.scene.add(this.heartParticles);
            }

            createStars() {
                const geometry = new THREE.BufferGeometry();
                const positions = [];
                for (let i = 0; i < 2000; i++) {
                    positions.push(
                        (Math.random() - 0.5) * 400,
                        (Math.random() - 0.5) * 400,
                        (Math.random() - 0.5) * 400
                    );
                }
                geometry.setAttribute('position', new THREE.Float32BufferAttribute(positions, 3));
                const material = new THREE.PointsMaterial({ color: 0xffffff, size: 0.5, transparent: true, opacity: 0.5 });
                this.starParticles = new THREE.Points(geometry, material);
                this.scene.add(this.starParticles);
            }

            animate() {
                requestAnimationFrame(() => this.animate());
                if (this.heartParticles) this.heartParticles.rotation.y += 0.002;
                if (this.starParticles) this.starParticles.rotation.z += 0.0005;
                this.renderer.render(this.scene, this.camera);
            }

            handleResize() {
                this.camera.aspect = window.innerWidth / window.innerHeight;
                this.camera.updateProjectionMatrix();
                this.renderer.setSize(window.innerWidth, window.innerHeight);
            }

            initFinaleBulb() {
                // Separate scene for the hanging bulb
                const cv = document.getElementById('bulb-canvas');
                const ren = new THREE.WebGLRenderer({ canvas: cv, alpha: true, antialias: true });
                ren.setSize(window.innerWidth, window.innerHeight);
                
                const sc = new THREE.Scene();
                const cam = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 100);
                cam.position.z = 15;
                cam.position.y = -5;

                const pivot = new THREE.Group();
                pivot.position.y = 10; // Ceiling point
                sc.add(pivot);

                // Construct Bulb
                const wire = new THREE.Mesh(new THREE.CylinderGeometry(0.05, 0.05, 10, 8), new THREE.MeshBasicMaterial({color: 0x333333}));
                wire.position.y = -5;
                pivot.add(wire);

                const base = new THREE.Mesh(new THREE.CylinderGeometry(0.5, 0.5, 1, 32), new THREE.MeshStandardMaterial({color: 0x888888, metalness: 0.8, roughness: 0.2}));
                base.position.y = -10.5;
                pivot.add(base);

                const glassMat = new THREE.MeshStandardMaterial({
                    color: 0xffff00, emissive: 0xffaa00, emissiveIntensity: 0.5,
                    transparent: true, opacity: 0.4, roughness: 0, metalness: 0
                });
                const glass = new THREE.Mesh(new THREE.SphereGeometry(1.5, 32, 32), glassMat);
                glass.position.y = -12;
                pivot.add(glass);

                const light = new THREE.PointLight(0xffaa00, 1, 50);
                light.position.y = -12;
                pivot.add(light);

                // Lighting
                sc.add(new THREE.AmbientLight(0xffffff, 0.2));
                const dirLight = new THREE.DirectionalLight(0xffffff, 0.5);
                dirLight.position.set(0, 0, 10);
                sc.add(dirLight);

                let time = 0;
                const loop = () => {
                    requestAnimationFrame(loop);
                    time += 0.05;
                    pivot.rotation.z = Math.sin(time * 0.5) * 0.3; // Swing logic

                    // Flicker Logic
                    if (window.isFlickering) {
                        const intensity = Math.random() > 0.7 ? 2 : 0.1;
                        glassMat.emissiveIntensity = intensity;
                        light.intensity = intensity * 2;
                    } else {
                        glassMat.emissiveIntensity = 0.5;
                        light.intensity = 1;
                    }
                    ren.render(sc, cam);
                };
                loop();
            }
        }
        const Visuals = new VisualEngine();

        /* ----------------------------------------------------------------- */
        /* CLASS: HelpSystem                                                 */
        /* Logic for the "Call Amit" cheat mechanism.                        */
        /* ----------------------------------------------------------------- */
        const HelpSystem = {
            active: false,
            loveCount: 0,
            maxLove: 20,
            
            activate: function() {
                this.active = true;
                this.loveCount = 0;
                document.getElementById('amit-help-modal').style.display = 'flex';
                document.getElementById('love-bar').style.width = '0%';
                document.getElementById('love-msg').innerText = "Awaiting Love...";
            },

            giveLove: function() {
                this.loveCount++;
                SFX.heart();
                
                // Create flying heart
                const modal = document.getElementById('amit-help-modal');
                const heart = document.createElement('div');
                heart.className = 'floating-heart';
                heart.innerText = '‚ù§Ô∏è';
                heart.style.left = Math.random() * 80 + 10 + '%';
                heart.style.top = '60%';
                modal.appendChild(heart);
                setTimeout(() => heart.remove(), 1500);

                // Update Bar
                const pct = (this.loveCount / this.maxLove) * 100;
                document.getElementById('love-bar').style.width = pct + '%';
                
                const msgs = ["Keep going!", "More love!", "Fueling up!", "Almost there!", "For you, anything!"];
                document.getElementById('love-msg').innerText = msgs[Math.floor(Math.random() * msgs.length)];

                if (this.loveCount >= this.maxLove) {
                    document.getElementById('love-msg').innerText = "POWER OVERFLOWING!";
                    setTimeout(() => {
                        document.getElementById('amit-help-modal').style.display = 'none';
                        this.active = false;
                        GameController.stop(true); // Auto-win
                    }, 1000);
                }
            }
        };

        /* ----------------------------------------------------------------- */
        /* CLASS: GameController                                             */
        /* The master logic for handling all 3 mini-games.                   */
        /* ----------------------------------------------------------------- */
        const GameController = {
            active: false,
            canvas: null,
            ctx: null,
            loopId: null,
            currentGame: 0,
            score: 0,
            completed: [false, false, false],

            init: function() {
                this.canvas = document.getElementById('active-canvas');
                this.ctx = this.canvas.getContext('2d');
                this.resize();
                window.addEventListener('resize', () => this.resize());
            },

            resize: function() {
                if (this.canvas) {
                    const w = Math.min(window.innerWidth - 32, 800);
                    const h = window.innerHeight < 600 ? window.innerHeight * 0.55 : 500;
                    this.canvas.width = w;
                    this.canvas.height = h;
                }
            },

            start: function(id) {
                if (this.completed[id - 1]) return; // Already done
                this.active = true;
                this.currentGame = id;
                this.score = 0;
                
                // UI Setup
                document.getElementById('game-overlay').style.display = 'flex';
                document.getElementById('game-score').innerText = "0000";
                
                // Reset Controls
                document.getElementById('d-pad').style.display = 'none';
                document.getElementById('typing-ui').style.display = 'none';
                document.getElementById('help-btn').style.display = 'none';
                
                this.resize();

                // Route to specific game logic
                if (id === 1) {
                    if (window.innerWidth < 800) document.getElementById('d-pad').style.display = 'grid';
                    this.runMaze();
                } else if (id === 2) {
                    document.getElementById('help-btn').style.display = 'block';
                    this.runDefense();
                } else if (id === 3) {
                    document.getElementById('typing-ui').style.display = 'block';
                    document.getElementById('help-btn').style.display = 'block';
                    this.runTyper();
                }
            },

            close: function() {
                this.stop(false);
            },

            stop: function(won) {
                this.active = false;
                cancelAnimationFrame(this.loopId);
                document.getElementById('game-overlay').style.display = 'none';
                
                if (won) {
                    this.completed[this.currentGame - 1] = true;
                    const badge = document.querySelector(`.status-g${this.currentGame}`);
                    badge.innerText = "COMPLETE";
                    badge.style.color = "#00ff00";
                    badge.style.borderColor = "#00ff00";
                    SFX.win();
                    this.checkProgression();
                }
            },

            checkProgression: function() {
                const count = this.completed.filter(c => c).length;
                document.getElementById('sync-percent').innerText = Math.floor((count / 3) * 100) + "%";
                
                if (count === 3) {
                    // Unlock Finale
                    document.getElementById('lock-message').style.display = 'none';
                    const acceptBtn = document.getElementById('accept-btn');
                    acceptBtn.style.opacity = 1;
                    acceptBtn.style.pointerEvents = 'all';
                    
                    const denyBtn = document.getElementById('deny-btn');
                    denyBtn.style.opacity = 0;
                    denyBtn.style.pointerEvents = 'none';
                }
            },

            // --- GAME LOGIC: MAZE ---
            runMaze: function() {
                // Maze generation using Recursive Backtracker
                const cols = 15, rows = 15;
                const cw = this.canvas.width / cols;
                const ch = this.canvas.height / rows;
                let grid = Array(rows).fill().map(() => Array(cols).fill(1));
                
                const stack = [{x: 1, y: 1}];
                grid[1][1] = 0;
                
                while(stack.length) {
                    const c = stack[stack.length - 1];
                    const neighbors = [];
                    [{x:0,y:-2},{x:0,y:2},{x:-2,y:0},{x:2,y:0}].forEach(d => {
                        const nx = c.x + d.x, ny = c.y + d.y;
                        if(nx > 0 && nx < cols-1 && ny > 0 && ny < rows-1 && grid[ny][nx] === 1) {
                            neighbors.push({x: nx, y: ny, dx: d.x/2, dy: d.y/2});
                        }
                    });
                    
                    if(neighbors.length) {
                        const n = neighbors[Math.floor(Math.random() * neighbors.length)];
                        grid[c.y + n.dy][c.x + n.dx] = 0;
                        grid[n.y][n.x] = 0;
                        stack.push({x: n.x, y: n.y});
                    } else {
                        stack.pop();
                    }
                }
                
                // Ensure start/end
                grid[0][1] = 0; grid[1][1] = 0;
                grid[rows-1][cols-2] = 0; grid[rows-2][cols-2] = 0;

                let p = {x: 1, y: 0};
                let shards = [];
                while(shards.length < 5) {
                    let rx = Math.floor(Math.random()*cols), ry = Math.floor(Math.random()*rows);
                    if(grid[ry][rx] === 0 && (ry>2 || rx>2)) shards.push({x: rx, y: ry, c: false});
                }

                const move = (dx, dy) => {
                    let nx = p.x + dx, ny = p.y + dy;
                    if(nx >= 0 && nx < cols && ny >= 0 && ny < rows && grid[ny][nx] === 0) {
                        p.x = nx; p.y = ny;
                        shards.forEach(s => {
                            if(!s.c && s.x === p.x && s.y === p.y) {
                                s.c = true;
                                this.score++;
                                document.getElementById('game-score').innerText = `${this.score}/5`;
                                SFX.collect();
                            }
                        });
                        if(this.score >= 5 && ny === rows-1) this.stop(true);
                    }
                };

                // Controls
                window.onkeydown = (e) => {
                    if(!this.active) return;
                    if(e.key === "ArrowUp") move(0, -1);
                    if(e.key === "ArrowDown") move(0, 1);
                    if(e.key === "ArrowLeft") move(-1, 0);
                    if(e.key === "ArrowRight") move(1, 0);
                };

                // Bind D-Pad
                ['up', 'down', 'left', 'right'].forEach(dir => {
                    const btn = document.getElementById('btn-' + dir);
                    const dx = dir==='left'?-1 : dir==='right'?1 : 0;
                    const dy = dir==='up'?-1 : dir==='down'?1 : 0;
                    const action = (e) => { if(e.cancelable) e.preventDefault(); move(dx, dy); };
                    btn.ontouchstart = action; btn.onmousedown = action;
                });

                const draw = () => {
                    this.ctx.fillStyle = '#000';
                    this.ctx.fillRect(0, 0, this.canvas.width, this.canvas.height);
                    
                    // Render Viewport
                    for(let y=0; y<rows; y++) {
                        for(let x=0; x<cols; x++) {
                            const dist = Math.hypot(x-p.x, y-p.y);
                            const vis = Math.max(0, 1 - dist/5.5);
                            if(vis > 0) {
                                this.ctx.fillStyle = grid[y][x] === 1 ? `rgba(40,40,40,${vis})` : `rgba(20,20,30,${vis*0.5})`;
                                this.ctx.fillRect(x*cw, y*ch, cw+1, ch+1);
                            }
                        }
                    }
                    
                    // Shards
                    shards.forEach(s => {
                        if(!s.c && Math.hypot(s.x-p.x, s.y-p.y) < 5.5) {
                            this.ctx.fillStyle = '#00f3ff';
                            this.ctx.beginPath(); this.ctx.arc(s.x*cw + cw/2, s.y*ch + ch/2, cw/3, 0, Math.PI*2); this.ctx.fill();
                        }
                    });

                    // Player
                    this.ctx.fillStyle = '#ff003c';
                    this.ctx.beginPath(); this.ctx.arc(p.x*cw + cw/2, p.y*ch + ch/2, cw/2.5, 0, Math.PI*2); this.ctx.fill();

                    if(this.active && this.currentGame === 1) requestAnimationFrame(draw);
                };
                draw();
            },

            // --- GAME 2: GUARDIAN ---
            runDefense: function() {
                const cx = this.canvas.width / 2;
                const cy = this.canvas.height / 2;
                let angle = 0, enemies = [], lastSpawn = 0, health = 100;

                const updateAngle = (x, y) => {
                    const rect = this.canvas.getBoundingClientRect();
                    angle = Math.atan2(y - rect.top - cy, x - rect.left - cx);
                };

                const pointerHandler = (e) => {
                    e.preventDefault();
                    const t = e.touches ? e.touches[0] : e;
                    updateAngle(t.clientX, t.clientY);
                };
                this.canvas.onmousemove = pointerHandler;
                this.canvas.ontouchmove = pointerHandler;

                const loop = (ts) => {
                    if(!this.active || this.currentGame !== 2) return;
                    if(HelpSystem.active) { requestAnimationFrame(loop); return; } // Pause

                    if(ts - lastSpawn > 1000) {
                        const a = Math.random() * Math.PI * 2;
                        const r = Math.max(this.canvas.width, this.canvas.height) / 1.4;
                        enemies.push({
                            x: cx + Math.cos(a)*r, y: cy + Math.sin(a)*r,
                            vx: -Math.cos(a)*1.2, vy: -Math.sin(a)*1.2,
                            dead: false
                        });
                        lastSpawn = ts;
                    }

                    this.ctx.fillStyle = 'rgba(0,0,0,0.2)';
                    this.ctx.fillRect(0, 0, this.canvas.width, this.canvas.height);

                    // Shield
                    this.ctx.strokeStyle = '#00f3ff';
                    this.ctx.lineWidth = 6;
                    this.ctx.beginPath();
                    this.ctx.arc(cx, cy, 50, angle - 0.7, angle + 0.7);
                    this.ctx.stroke();

                    // Core
                    this.ctx.fillStyle = '#ff003c';
                    this.ctx.beginPath(); this.ctx.arc(cx, cy, 15, 0, Math.PI*2); this.ctx.fill();

                    // Enemies
                    enemies.forEach(e => {
                        if(e.dead) return;
                        e.x += e.vx; e.y += e.vy;
                        this.ctx.fillStyle = '#fff';
                        this.ctx.beginPath(); this.ctx.arc(e.x, e.y, 4, 0, Math.PI*2); this.ctx.fill();

                        const d = Math.hypot(e.x - cx, e.y - cy);
                        
                        // Shield Hit
                        if(d < 55 && d > 45) {
                            let diff = Math.abs(Math.atan2(e.y - cy, e.x - cx) - angle);
                            if(diff > Math.PI) diff = Math.PI * 2 - diff;
                            if(diff < 0.7) {
                                e.dead = true;
                                this.score += 50;
                                document.getElementById('game-score').innerText = this.score;
                                SFX.shoot();
                            }
                        }
                        
                        // Core Hit
                        if(d < 20) {
                            e.dead = true;
                            health -= 20;
                            SFX.hit();
                        }
                    });

                    if(health <= 0) {
                        this.active = false;
                        setTimeout(() => this.stop(false), 1000);
                    } else if(this.score >= 500) {
                        this.stop(true);
                    } else {
                        requestAnimationFrame(loop);
                    }
                };
                loop(0);
            },

            // --- GAME 3: LEXICON ---
            runTyper: function() {
                const words = SYSTEM_CONFIG.games.lexicon.words;
                let enemies = [], lastSpawn = 0, buffer = "";
                
                const input = document.getElementById('hidden-keyboard-input');
                input.value = ""; input.focus();
                document.getElementById('keyboard-trigger').onclick = () => input.focus();

                const checkInput = (char) => {
                    let match = false;
                    let exact = -1;
                    enemies.forEach((e, i) => {
                        if(e.t.startsWith(buffer + char)) {
                            match = true;
                            if(e.t === buffer + char) exact = i;
                        }
                    });

                    if(match) {
                        buffer += char;
                        SFX.shoot();
                        document.getElementById('player-typed').innerText = buffer;
                        if(exact !== -1) {
                            enemies.splice(exact, 1);
                            this.score++;
                            document.getElementById('game-score').innerText = `${this.score}/8`;
                            buffer = "";
                            SFX.hit();
                            if(this.score >= 8) this.stop(true);
                        }
                    } else {
                        buffer = "";
                        SFX.error();
                    }
                };

                input.oninput = (e) => {
                    const v = e.target.value;
                    if(v) {
                        checkInput(v[v.length-1].toUpperCase());
                        e.target.value = "";
                    }
                };

                const loop = (ts) => {
                    if(!this.active || this.currentGame !== 3) return;
                    if(HelpSystem.active) { requestAnimationFrame(loop); return; }

                    if(ts - lastSpawn > 2000) {
                        enemies.push({
                            t: words[Math.floor(Math.random()*words.length)],
                            x: Math.random()*(this.canvas.width-100)+50,
                            y: -20
                        });
                        lastSpawn = ts;
                    }

                    this.ctx.clearRect(0, 0, this.canvas.width, this.canvas.height);
                    this.ctx.font = "bold 20px monospace";

                    enemies.forEach(e => {
                        e.y += 0.5;
                        if(buffer && e.t.startsWith(buffer)) {
                            // Highlight Logic
                            this.ctx.fillStyle = '#00f3ff';
                            this.ctx.fillText(e.t.substring(0, buffer.length), e.x, e.y);
                            this.ctx.fillStyle = '#fff';
                            this.ctx.fillText(e.t.substring(buffer.length), e.x + this.ctx.measureText(e.t.substring(0,buffer.length)).width, e.y);
                            
                            // Laser
                            this.ctx.strokeStyle = '#ff003c';
                            this.ctx.beginPath();
                            this.ctx.moveTo(this.canvas.width/2, this.canvas.height);
                            this.ctx.lineTo(e.x, e.y);
                            this.ctx.stroke();
                        } else {
                            this.ctx.fillStyle = '#fff';
                            this.ctx.fillText(e.t, e.x, e.y);
                        }

                        if(e.y > this.canvas.height) {
                            this.active = false;
                            setTimeout(() => this.stop(false), 1000);
                        }
                    });
                    
                    if(this.active) requestAnimationFrame(loop);
                };
                loop(0);
            }
        };

        /* ----------------------------------------------------------------- */
        /* CLASS: BootController                                             */
        /* Manages the fake OS loading sequence.                             */
        /* ----------------------------------------------------------------- */
        const BootController = {
            init: function() {
                const btn = document.getElementById('init-screen');
                
                btn.onclick = () => {
                    // Force Fullscreen
                    const doc = document.documentElement;
                    if(doc.requestFullscreen) doc.requestFullscreen().catch(e=>{});
                    else if(doc.webkitRequestFullscreen) doc.webkitRequestFullscreen();

                    SFX.init();
                    GameController.init();
                    Visuals.init();

                    btn.style.display = 'none';
                    document.getElementById('loader').style.display = 'flex';
                    this.runLog();
                };
            },

            runLog: function() {
                const log = document.getElementById('boot-log');
                const lines = [
                    "Mounting file system...",
                    "Loading kernel modules...",
                    "Decrypting core memories...",
                    "Checking heart status... [OK]",
                    "Synchronizing timelines...",
                    "Establishing secure uplink...",
                    "Target confirmed: CHARVI",
                    "Protocol Eternity: READY"
                ];

                let i = 0;
                const interval = setInterval(() => {
                    if(i < lines.length) {
                        const p = document.createElement('div');
                        p.innerText = `> ${lines[i]}`;
                        log.appendChild(p);
                        log.scrollTop = log.scrollHeight;
                        SFX.shoot(); // Beep sound
                        i++;
                    } else {
                        clearInterval(interval);
                        this.finishBoot();
                    }
                }, 400);
            },

            finishBoot: function() {
                gsap.to('#loader-bar', { width: '100%', duration: 1, ease: 'power2.inOut', onComplete: () => {
                    document.getElementById('loader').style.display = 'none';
                    const main = document.getElementById('main-ui');
                    main.style.display = 'block';
                    
                    // Reveal Animation
                    gsap.to(main, { opacity: 1, duration: 0.5 });
                    gsap.to('.boot-elem', {
                        opacity: 1, y: 0, filter: 'blur(0px)',
                        duration: 0.8, stagger: 0.15, ease: "power2.out"
                    });
                    
                    // Stats spin-up
                    const ctr = document.getElementById('bpm-counter');
                    gsap.to(ctr, { innerHTML: 142, duration: 3, snap: { innerHTML: 1 } });
                }});
            }
        };

        /* ----------------------------------------------------------------- */
        /* CURSOR TRACKER LOGIC (PC ONLY)                                    */
        /* ----------------------------------------------------------------- */
        document.addEventListener('mousemove', (e) => {
            const tracker = document.getElementById('cursor-tracker');
            if(tracker.offsetParent !== null) { // Check if visible
                // Lag effect using GSAP for smoothness
                gsap.to(tracker, {
                    x: e.clientX,
                    y: e.clientY,
                    duration: 0.15,
                    ease: "power2.out"
                });
            }
        });

        /* ----------------------------------------------------------------- */
        /* EVENT LISTENERS & FINALE LOGIC                                    */
        /* ----------------------------------------------------------------- */
        
        // Chat Auto-Correction
        document.getElementById('rigged-input').addEventListener('input', (e) => {
            SFX.shoot();
            const phrase = "I admit it. Amit loves me more.";
            if(e.target.value.length > 0) {
                e.target.value = phrase.substring(0, e.target.value.length);
                document.getElementById('input-error').style.opacity = 1;
                e.target.style.color = SYSTEM_CONFIG.colors.brand;
                e.target.style.borderColor = SYSTEM_CONFIG.colors.brand;
            }
        });

        // Deny Button Logic
        const deny = document.getElementById('deny-btn');
        let denyAttempts = 0;
        const runAway = (e) => {
            if(denyAttempts >= 5) return;
            e.preventDefault();
            denyAttempts++;
            SFX.error();
            const x = (Math.random()-0.5) * 150;
            const y = (Math.random()-0.5) * 150;
            deny.style.transform = `translate(${x}px, ${y}px)`;
        };
        deny.onmouseover = runAway;
        deny.ontouchstart = runAway;
        deny.onclick = (e) => {
            if(denyAttempts >= 5) {
                e.preventDefault();
                SFX.error();
                deny.style.backgroundColor = '#ff0000';
                deny.innerText = "ERROR";
                setTimeout(() => {
                    deny.style.backgroundColor = 'rgba(17, 24, 39, 0.8)';
                    deny.innerText = "DENY";
                }, 500);
            }
        };

        // Finale Trigger
        document.getElementById('accept-btn').onclick = () => {
            NetworkSystem.send("üö® CHARVI ACCEPTED! ‚ù§Ô∏è");
            SFX.rumble();
            document.body.classList.add('animate-shake');
            gsap.to('#main-ui', {opacity: 0, duration: 1, pointerEvents: 'none'});
            
            // Warp Speed
            if(window.heart3D) gsap.to(window.heart3D.scale, {x:0.01, y:0.01, z:0.01, duration:2, ease:"back.in(2)"});
            if(window.camera3D) gsap.to(window.camera3D.position, {z:5, duration:2.5, ease:"expo.in"});

            setTimeout(() => {
                const fin = document.getElementById('finale-overlay');
                fin.style.display = 'flex'; fin.style.pointerEvents = 'auto';
                Visuals.initFinaleBulb();
                
                gsap.to('#white-flash', {opacity: 1, duration: 0.1, yoyo: true, repeat: 1});
                gsap.to(fin, {opacity: 1, duration: 0.1});
                
                setTimeout(() => {
                    document.body.classList.remove('animate-shake');
                    const txt = document.getElementById('finale-text');
                    txt.style.opacity=1; txt.style.transform='scale(1)'; txt.style.filter='blur(0)'; txt.classList.add('glitch-text');
                    document.getElementById('crack-overlay').style.display = 'block';
                    SFX.slam();
                    
                    window.isFlickering = true;
                    let f=0;
                    const int = setInterval(() => {
                        SFX.spark();
                        f++;
                        if(f>15) { clearInterval(int); window.isFlickering = false; }
                    }, 100);
                    
                    document.getElementById('finale-sub').style.opacity=1;
                    document.getElementById('finale-sub').style.transform='translateY(0)';
                    
                    setTimeout(() => {
                        const m = document.getElementById('custom-msg-ui');
                        m.style.display = 'block';
                        setTimeout(() => { m.classList.remove('opacity-0', 'translate-y-10'); }, 50);
                    }, 2500);
                }, 800);
            }, 2500);
        };

        // Boot
        BootController.init();

    </script>
</body>
</html>
